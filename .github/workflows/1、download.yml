# 工作流名称:（下载文件 → 添加到git → 提交 → 推送）
name: X

# 触发条件
on:
  # 定时触发
  schedule:
    # 每小时执行一次（cron表达式：分钟 小时 日 月 星期）每天执行1次
    - cron: "0 0 * * *"
  # 手动触发（允许在 GitHub 界面上手动运行）
  workflow_dispatch:

# 定义作业
jobs:
  # 作业1，命名为 j1
  j1:
    # 运行环境：最新版 Ubuntu
    runs-on: ubuntu-latest
    
    # 作业步骤
    steps:
      # 步骤1：检出代码到工作区
      - uses: actions/checkout@v3
      
      # 步骤2：自定义步骤
      - name: s1
        # 设置环境变量（从仓库secrets中读取）
        env:
          # 从secrets读取 url1 并赋值给 url1 环境变量
          url1: ${{ secrets.url1 }}
          # 从secrets读取 file1 并赋值给 file1 环境变量
          file1: ${{ secrets.file1 }}
          # 从secrets读取 url2 并赋值给 url2 环境变量
          url2: ${{ secrets.url2 }}
          # 从secrets读取 file2 并赋值给 file2 环境变量
          file2: ${{ secrets.file2 }}
          # 从secrets读取 url3 并赋值给 url3 环境变量
          url3: ${{ secrets.url3 }}
          # 从secrets读取 file3 并赋值给 file3 环境变量
          file3: ${{ secrets.file3 }}
          # 从secrets读取 gu 并赋值给 gu 环境变量（git用户名）
          gu: ${{ secrets.gu }}
          # 从secrets读取 ge 并赋值给 ge 环境变量（git邮箱）
          ge: ${{ secrets.ge }}
        # 使用 Python 作为 shell 执行脚本
        run: |
          # 导入必要的 Python 模块
          import datetime, os
          
          # 获取当前 UTC 时间并格式化为字符串
          t = datetime.datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')
          # 创建提交信息：LUT-时间（移除空格和冒号）
          m = f"LUT-{t.replace(' ', '').replace(':','')}"
          
          # 配置 git 用户名
          os.system(f'git config --global user.name "{os.environ["gu"]}"')
          # 配置 git 邮箱
          os.system(f'git config --global user.email "{os.environ["ge"]}"')
          
          # 定义要下载的URL和文件名对的列表
          download_pairs = [
              (os.environ.get("url1"), os.environ.get("file1")),  # 第一对URL和文件名
              (os.environ.get("url2"), os.environ.get("file2")),  # 第二对URL和文件名
              (os.environ.get("url3"), os.environ.get("file3")),  # 第三对URL和文件名
          ]
          
          # 循环遍历所有下载对
          for url, filename in download_pairs:
              # 检查URL和文件名是否都存在
              if url and filename:
                  # 使用 curl 下载文件：从环境变量 url 下载文件到 filename
                  os.system(f'curl -sSL "{url}" -o "{filename}"')
                  # 将下载的文件添加到 git 暂存区
                  os.system(f'git add {filename}')
                  # 打印下载信息
                  print(f"Downloaded: {url} -> {filename}")
              else:
                  # 如果URL或文件名为空，跳过该对
                  print(f"Skipped empty pair: url={url}, filename={filename}")
          
          # 提交更改，使用生成的消息 m
          # 如果提交失败（没有变化），输出 'x' 避免脚本失败
          os.system(f'git commit -m "{m}" || echo x')
          
          # 推送更改到远程仓库
          os.system('git push')
          
          # 打印提交消息（便于在日志中查看）
          print(f"MSG:{m}")
        # 指定使用 Python 解释器执行脚本
        shell: python
