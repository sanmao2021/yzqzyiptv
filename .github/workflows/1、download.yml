# 工作流名称:（下载文件 → 添加到git → 提交 → 推送）
name: 自动下载文件

# 触发条件
on:
  # 定时触发
  schedule:
    # 每小时执行一次（cron表达式：分钟 小时 日 月 星期）每天执行1次
    - cron: "0 0 * * *"
  # 手动触发（允许在 GitHub 界面上手动运行）
  workflow_dispatch:

# 定义作业
jobs:
  # 作业1，命名为 j1
  j1:
    # 运行环境：最新版 Ubuntu
    runs-on: ubuntu-latest
    
    # 作业步骤
    steps:
      # 步骤1：检出代码到工作区
      - uses: actions/checkout@v3
        with:
          # 明确指定分支（改为你的分支名）
          ref: main
      
      # 步骤2：自定义步骤
      - name: s1
        # 设置环境变量（从仓库secrets中读取）
        env:
          url_1: ${{ secrets.url_1 }}
          file_1: ${{ secrets.file_1 }}
          url_2: ${{ secrets.url_2 }}
          file_2: ${{ secrets.file_2 }}
          url_3: ${{ secrets.url_3 }}
          file_3: ${{ secrets.file_3 }}
          git_user: ${{ secrets.git_user }}
          git_email: ${{ secrets.git_email }}
        # 使用 Python 作为 shell 执行脚本
        run: |
          # 导入必要的 Python 模块
          import datetime, os, subprocess
          
          
          # 检查环境变量
for key in ['url_1', 'file_1', 'url_2', 'file_2', 'url_3', 'file_3', 'git_user', 'git_email']:
    value = os.environ.get(key)
    if value:
        print(f"{key}: 已设置（值隐藏）")
    else:
        print(f"{key}: 未设置")
          
          
          # 调试信息：显示当前目录
          print("=" * 50)
          print("当前工作目录:", os.getcwd())
          print("目录内容:")
          os.system('ls -la')
          print("=" * 50)
          
          # 显示 git 信息
          print("Git 信息:")
          os.system('git branch -a')
          os.system('git remote -v')
          print("=" * 50)
          
          # 获取当前 UTC 时间并格式化为字符串
          t = datetime.datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')
          # 创建提交信息：LUT-时间（移除空格和冒号）
          m = f"LUT-{t.replace(' ', '').replace(':','')}"
          
          # 配置 git 用户名
          os.system(f'git config --global user.name "{os.environ["git_user"]}"')
          # 配置 git 邮箱
          os.system(f'git config --global user.email "{os.environ["git_email"]}"')
          
          # 定义要下载的URL和文件名对的列表
          download_pairs = [
              (os.environ.get("url_1"), os.environ.get("file_1")),
              (os.environ.get("url_2"), os.environ.get("file_2")),
              (os.environ.get("url_3"), os.environ.get("file_3")),
          ]
          
          # 循环遍历所有下载对
          files_added = False
          for url, filename in download_pairs:
              # 检查URL和文件名是否都存在
              if url and filename:
                  print(f"\n正在处理: {filename}")
                  print(f"URL: {url}")
                  
                  # 使用 curl 下载文件
                  curl_cmd = f'curl -fsSL "{url}" -o "{filename}"'
                  print(f"执行命令: {curl_cmd}")
                  
                  result = os.system(curl_cmd)
                  if result == 0:
                      # 检查文件是否存在且非空
                      if os.path.exists(filename):
                          file_size = os.path.getsize(filename)
                          print(f"✓ 下载成功: {filename} ({file_size} 字节)")
                          
                          if file_size > 0:
                              # 添加到 git
                              os.system(f'git add {filename}')
                              files_added = True
                              print(f"✓ 已添加到 git: {filename}")
                          else:
                              print(f"⚠ 文件为空: {filename}")
                      else:
                          print(f"✗ 文件不存在: {filename}")
                  else:
                      print(f"✗ 下载失败: {url}")
                      print(f"错误代码: {result}")
              else:
                  print(f"⚠ 跳过空对: url={url}, filename={filename}")
          
          print("\n" + "=" * 50)
          print("Git 状态:")
          os.system('git status')
          print("=" * 50)
          
          if files_added:
              # 提交更改
              commit_cmd = f'git commit -m "{m}"'
              print(f"提交命令: {commit_cmd}")
              os.system(commit_cmd)
              
              # 推送更改到远程仓库
              print("\n开始推送...")
              push_result = os.system('git push')
              if push_result == 0:
                  print("✓ 推送成功！")
              else:
                  print(f"✗ 推送失败！错误代码: {push_result}")
          else:
              print("没有文件需要提交，跳过提交和推送")
          
          # 打印提交消息
          print(f"\n提交信息: {m}")
          print("=" * 50)
        # 指定使用 Python 解释器执行脚本
        shell: python
