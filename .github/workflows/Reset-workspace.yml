# 工作流名称：系统同步
name: System Sync(系统同步,重置，恢复出厂设置)

# 定义工作流触发条件
on:
  # 仅支持手动触发 - 只能在 GitHub 界面手动运行此工作流
  # 无定时触发，说明这是一个需要人工干预的重要操作
  workflow_dispatch:

# 定义作业
jobs:
  # 作业名称：update-environment（更新环境）
  update-environment:
    # 指定作业运行环境：最新版 Ubuntu Linux
    runs-on: ubuntu-latest

    # 定义作业执行步骤序列
    steps:
      # 步骤1：获取最新环境状态
      - name: Fetch latest environment
        # 使用 GitHub 官方 checkout action v4 版本
        uses: actions/checkout@v4
        # 传递给 action 的参数配置
        with:
          # fetch-depth: 0 表示获取完整的 Git 历史记录，而不是浅克隆
          # 这确保所有分支、标签和完整提交历史都被下载
          fetch-depth: 0

      # 步骤2：重置工作区
      - name: Reset workspace
        # 执行多条 shell 命令
        run: |
          # 输出信息，提示正在清除本地缓存
          echo "Clearing local cache..."
          # 删除 .git 目录，这将移除所有 Git 版本控制信息
          # 相当于将工作区重置为普通目录，失去版本控制功能
          rm -rf .git
          # 输出信息，提示缓存已清除
          echo "Cache cleared."

      # 步骤3：初始化项目基线
      - name: Initialize project baseline
        run: |
          # 重新初始化 Git 仓库，创建新的 .git 目录
          git init
          # 配置 Git 用户名，从 GitHub Secrets 中获取
          git config user.name "${{ secrets.GIT_U }}"
          # 配置 Git 邮箱，从 GitHub Secrets 中获取
          git config user.email "${{ secrets.GIT_E }}"
          # 将当前目录所有文件添加到暂存区（. 表示所有文件）
          git add .
          # 提交所有更改，创建新的初始提交
          git commit -m "Baseline snapshot"

      # 步骤4：同步到远程仓库
      - name: Synchronize remote repository
        # 设置环境变量
        env:
          # 使用 GitHub 自动生成的令牌进行认证
          AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 将当前分支重命名为 main（Git 默认主分支名称）
          git branch -M main
          # 添加远程仓库地址，使用 GitHub Token 进行认证
          # 格式：https://x-access-token:TOKEN@github.com/用户名/仓库名.git
          git remote add origin https://x-access-token:${AUTH_TOKEN}@github.com/${{ github.repository }}.git
          # 将本地 main 分支推送到远程仓库
          # -u: 设置上游分支，后续可以使用 git push/pull 而不需要指定分支
          # --force: 强制推送，覆盖远程仓库的内容
          git push -u origin main --force
