# 工作流名称：X（建议使用更具描述性的名称，如"Auto File Download"）
name: X

# 定义工作流触发条件
on:
  # 定时触发 - 使用 cron 表达式定义执行时间表
  schedule:
    # 每10分钟执行一次（分钟 小时 日 月 星期）
    # */10 表示每10分钟执行一次，即在每小时的第0、10、20、30、40、50分钟执行
    - cron: "*/10 * * * *"
  
  # 手动触发 - 允许在 GitHub 仓库的 Actions 页面手动运行此工作流
  workflow_dispatch:

# 定义作业
jobs:
  # 作业名称：j1（建议使用更具描述性的名称）
  j1:
    # 指定作业运行环境：最新版 Ubuntu Linux
    runs-on: ubuntu-latest
    
    # 定义作业执行步骤序列
    steps:
      # 步骤1：检出代码仓库
      # 使用 actions/checkout@v3 将仓库代码下载到工作目录
      - uses: actions/checkout@v3
      
      # 步骤2：执行 Python 脚本
      # 步骤名称：s1
      - name: s1
        # 设置环境变量，从 GitHub Secrets 中读取敏感信息
        env:
          # a1: 从 secrets.ws 获取下载文件的 URL
          a1: ${{ secrets.ws }}
          # b2: 从 secrets.wf 获取保存文件的文件名
          b2: ${{ secrets.wf }}
          # c3: 从 secrets.gu 获取 Git 用户名
          c3: ${{ secrets.gu }}
          # d4: 从 secrets.ge 获取 Git 邮箱
          d4: ${{ secrets.ge }}
        
        # 执行 Python 代码块
        run: |
          # 导入必要的 Python 模块
          # datetime: 用于获取和格式化当前时间
          # os: 用于执行系统命令和访问环境变量
          import datetime, os
          
          # 获取当前 UTC 时间并格式化为字符串
          # strftime 格式：%Y-年，%m-月，%d-日，%H-时(24小时制)，%M-分，%S-秒
          # 示例输出："2024-01-01 12:00:00 UTC"
          t = datetime.datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')
          
          # 创建提交消息字符串
          # 格式："LUT-时间戳"，其中时间戳去除了空格和冒号
          # 示例："LUT-2024-01-01120000UTC"
          m = f"LUT-{t.replace(' ', '').replace(':','')}"
          
          # 使用 curl 命令下载文件
          # curl 参数说明：
          #   -s: 静默模式（不显示进度信息）
          #   -S: 与 -s 一起使用时，如果失败则显示错误信息
          #   -L: 跟随重定向
          #   -o: 指定输出文件名
          # 从环境变量 a1 获取 URL，保存到环境变量 b2 指定的文件名
          os.system(f'curl -sSL "{os.environ["a1"]}" -o "{os.environ["b2"]}"')
          
          # 配置 Git 全局用户名
          # 从环境变量 c3 获取用户名
          os.system(f'git config --global user.name "{os.environ["c3"]}"')
          
          # 配置 Git 全局邮箱
          # 从环境变量 d4 获取邮箱
          os.system(f'git config --global user.email "{os.environ["d4"]}"')
          
          # 将下载的文件添加到 Git 暂存区
          # 从环境变量 b2 获取文件名
          os.system(f'git add {os.environ["b2"]}')
          
          # 提交更改到本地仓库
          # 使用变量 m 的值作为提交信息
          # || echo x: 如果 git commit 命令失败（例如没有变更可提交），则执行 echo x
          # 这样可以避免脚本因为提交失败而终止
          os.system(f'git commit -m "{m}" || echo x')
          
          # 将本地提交推送到远程仓库
          os.system('git push')
          
          # 打印提交消息，方便在 GitHub Actions 日志中查看
          print(f"MSG:{m}")
        
        # 指定使用 Python 作为 shell 执行上述代码
        shell: python
